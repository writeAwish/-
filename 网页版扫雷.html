<!-- index.html | Web æ‰«é›·ï¼ˆä¿®å¤æ¸…ç©ºæˆç»©ä¸ç»Ÿè®¡ï¼‰ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ‰«é›· | ç”¨æˆ·åä¸æˆç»©è®°å½•</title>
<style>
  :root{
    --cell:28px;
    --gap:2px;
    --font:14px;
    --bg:#0f172a;
    --panel:#111827;
    --muted:#9ca3af;
    --ok:#10b981;
    --bad:#ef4444;
    --warn:#f59e0b;
    --fg:#e5e7eb;
    --grid:#1f2937;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans",sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1fr 340px;gap:16px}
  header{
    grid-column:1/-1;background:var(--panel);border-radius:12px;padding:12px 16px;display:flex;flex-wrap:wrap;align-items:center;gap:12px
  }
  header h1{font-size:18px;margin:0 8px 0 0;letter-spacing:.5px}
  .group{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
  input,select,button{
    background:#0b1020;color:var(--fg);border:1px solid #334155;border-radius:8px;
    padding:6px 10px;font-size:14px;outline:none
  }
  input[type=number]{width:90px}
  button{cursor:pointer}
  button.primary{background:#1d4ed8;border-color:#1d4ed8}
  button.ghost{background:transparent}
  button.ok{background:var(--ok);border-color:var(--ok);color:#062a22}
  button.warn{background:var(--warn);border-color:var(--warn);color:#2b1d04}
  button.bad{background:var(--bad);border-color:var(--bad)}
  .counter{padding:6px 10px;border-radius:8px;background:#0b1020;border:1px solid #334155;min-width:84px;text-align:center}
  .flex{display:flex;align-items:center;gap:8px}
  .panel{background:var(--panel);border-radius:12px;padding:12px}
  #board{
    background:var(--grid);padding:var(--gap);border-radius:12px;overflow:auto;max-height:calc(100vh - 220px)
  }
  .grid{display:grid;gap:var(--gap);width:max-content}
  .cell{
    width:var(--cell);height:var(--cell);display:flex;align-items:center;justify-content:center;
    background:#0b1020;border:1px solid #1f2937;border-radius:6px;user-select:none;
    font-weight:700;font-size:14px;line-height:1;cursor:pointer;
    transition:transform .02s ease-in-out
  }
  .cell:active{transform:translateY(1px)}
  .cell.revealed{background:#111827;border-color:#374151;cursor:default}
  .cell.flag{background:#0b1020}
  .cell.mine.revealed{background:#3f1d1d;border-color:#b91c1c}
  .n1{color:#60a5fa}.n2{color:#34d399}.n3{color:#f87171}.n4{color:#60a5fa}
  .n5{color:#f59e0b}.n6{color:#22d3ee}.n7{color:#e5e7eb}.n8{color:#9ca3af}
  #sidebar .panel + .panel{margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid #374151;padding:6px 6px;text-align:left;white-space:nowrap}
  th{position:sticky;top:0;background:var(--panel)}
  .muted{color:var(--muted)}
  .status{font-weight:700}
  .status.ok{color:var(--ok)} .status.bad{color:var(--bad)} .status.run{color:#38bdf8}
  .chip{padding:2px 8px;border-radius:999px;background:#0b1020;border:1px solid #334155;font-size:12px}
  .help{font-size:12px;color:var(--muted)}
  @media (max-width:960px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>æ‰«é›·</h1>

    <div class="group">
      <span class="muted">ç”¨æˆ·</span>
      <input id="username" placeholder="è¾“å…¥ç”¨æˆ·å" />
      <button id="saveName" class="primary">ä¿å­˜</button>
      <span id="currentUser" class="chip"></span>
    </div>

    <div class="group">
      <span class="muted">éš¾åº¦</span>
      <select id="difficulty">
        <option value="beginner">åˆçº§ 9Ã—9 / 10é›·</option>
        <option value="intermediate">ä¸­çº§ 16Ã—16 / 40é›·</option>
        <option value="expert">é«˜çº§ 30Ã—16 / 99é›·</option>
        <option value="custom">è‡ªå®šä¹‰</option>
      </select>
      <span class="muted">è¡Œ</span><input id="rows" type="number" min="5" max="50" value="9" />
      <span class="muted">åˆ—</span><input id="cols" type="number" min="5" max="50" value="9" />
      <span class="muted">é›·</span><input id="mines" type="number" min="1" max="2000" value="10" />
      <button id="newGame" class="ok">æ–°æ¸¸æˆ</button>
    </div>

    <div class="group">
      <div id="timer" class="counter">â± 000</div>
      <div id="mineCount" class="counter">ğŸ’£ 000</div>
      <button id="flagMode" class="warn">æ ‡è®°æ¨¡å¼ï¼šå…³</button>
      <span id="status" class="status">å°±ç»ª</span>
    </div>
  </header>

  <div id="board" class="panel">
    <div id="grid" class="grid" aria-label="æ‰«é›·æ£‹ç›˜"></div>
    <div class="help" style="margin-top:8px">
      PCï¼šå·¦é”®å¼€æ ¼ï¼Œå³é”®æ’æ——ï¼Œå·²ç¿»å¼€çš„æ•°å­—åŒå‡»â€œæ‰«é›·â€ã€‚ç§»åŠ¨ç«¯ï¼šå¯åˆ‡æ¢â€œæ ‡è®°æ¨¡å¼â€ã€‚é¦–å‡»ä¸æ­»ã€‚
    </div>
  </div>

  <div id="sidebar">
    <div class="panel">
      <div class="flex" style="justify-content:space-between">
        <strong>æˆç»©æ¦œ</strong>
        <label class="flex" style="gap:4px"><input id="onlyMine" type="checkbox" /> åªçœ‹å½“å‰ç”¨æˆ·</label>
      </div>
      <div class="help" style="margin:6px 0 10px">ä»…è®°å½•èƒœåˆ©ç”¨æ—¶ã€‚æ•°æ®ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ã€‚</div>
      <div style="overflow:auto;max-height:420px">
        <table id="scoreTable">
          <thead>
            <tr><th>#</th><th>ç”¨æˆ·</th><th>å°ºå¯¸</th><th>é›·</th><th>ç”¨æ—¶</th><th>æ—¥æœŸ</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="flex" style="margin-top:10px;gap:8px;flex-wrap:wrap">
        <button id="clearScores" class="bad">æ¸…ç©ºæˆç»©ä¸ç»Ÿè®¡</button>
      </div>
    </div>

    <div class="panel">
      <strong>ç»Ÿè®¡</strong>
      <div class="help" id="stats">èƒœï¼š0ï½œè´Ÿï¼š0ï½œèƒœç‡ï¼š0%</div>
    </div>
  </div>
</div>

<script>
(function(){
  // â€”â€” å…¨å±€çŠ¶æ€ â€”â€”
  const el = {
    grid: document.getElementById('grid'),
    board: document.getElementById('board'),
    timer: document.getElementById('timer'),
    mineCount: document.getElementById('mineCount'),
    status: document.getElementById('status'),
    difficulty: document.getElementById('difficulty'),
    rows: document.getElementById('rows'),
    cols: document.getElementById('cols'),
    mines: document.getElementById('mines'),
    newGame: document.getElementById('newGame'),
    flagMode: document.getElementById('flagMode'),
    username: document.getElementById('username'),
    saveName: document.getElementById('saveName'),
    currentUser: document.getElementById('currentUser'),
    onlyMine: document.getElementById('onlyMine'),
    scoreTable: document.querySelector('#scoreTable tbody'),
    clearScores: document.getElementById('clearScores'),
    stats: document.getElementById('stats'),
  };

  let R=9,C=9,M=10;
  let cells=[]; // æ¯æ ¼ï¼š{mine,revealed,flag,adj}
  let firstClick=true, alive=true, flags=0, revealed=0;
  let totalNonMine=0;
  let t=0, tHandle=null;
  let wins = +(localStorage.getItem('ms_wins')||0);
  let loses = +(localStorage.getItem('ms_loses')||0);

  // â€”â€” æœ¬åœ°å­˜å‚¨ï¼šç”¨æˆ·åä¸æˆç»© â€”â€”
  const LS_USER='ms_username';
  const LS_SCORES='ms_scores_v1';
  function getUser(){ return localStorage.getItem(LS_USER)||'' }
  function setUser(name){ localStorage.setItem(LS_USER, name||'') }
  function loadScores(){
    try{ return JSON.parse(localStorage.getItem(LS_SCORES)||'[]') }catch{ return [] }
  }
  function saveScores(arr){ localStorage.setItem(LS_SCORES, JSON.stringify(arr)) }

  // â€”â€” å·¥å…· â€”â€”
  function idx(r,c){ return r*C + c }
  function inBounds(r,c){ return r>=0 && r<R && c>=0 && c<C }
  function neigh(i){
    const r=Math.floor(i/C), c=i%C, out=[];
    for(let dr=-1; dr<=1; dr++)for(let dc=-1; dc<=1; dc++){
      if(dr===0 && dc===0) continue;
      const rr=r+dr, cc=c+dc;
      if(inBounds(rr,cc)) out.push(idx(rr,cc));
    }
    return out;
  }
  function formatTime(s){
    if(s>=3600){const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60; return `${h}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`}
    return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`
  }
  function setStatus(text, cls){
    el.status.className='status'+(cls?(' '+cls):''); el.status.textContent=text;
  }
  function setCounters(){
    el.timer.textContent = `â± ${String(t).padStart(3,'0')}`;
    el.mineCount.textContent = `ğŸ’£ ${String(M - flags).padStart(3,'0')}`;
  }

  // â€”â€” è®¡æ—¶ â€”â€”
  function startTimer(){
    if(tHandle) return;
    tHandle = setInterval(()=>{ t++; el.timer.textContent=`â± ${String(t).padStart(3,'0')}`; },1000);
  }
  function stopTimer(){
    if(tHandle){ clearInterval(tHandle); tHandle=null; }
  }
  function resetTimer(){ stopTimer(); t=0; setCounters(); }

  // â€”â€” æ£‹ç›˜ç”Ÿæˆ â€”â€”
  function setupGrid(){
    el.grid.style.gridTemplateColumns = `repeat(${C}, var(--cell))`;
    el.grid.innerHTML='';
    for(let i=0;i<R*C;i++){
      const d=document.createElement('div');
      d.className='cell';
      d.dataset.i=i;
      d.setAttribute('aria-label','æœªç¿»å¼€');
      d.addEventListener('click', onLeftClick);
      d.addEventListener('contextmenu', onRightClick);
      d.addEventListener('dblclick', onChord);
      el.grid.appendChild(d);
    }
    // ç¦ç”¨åŸç”Ÿå³é”®èœå•
    el.grid.addEventListener('contextmenu', e=>e.preventDefault());
  }
  function initCells(){
    cells = Array.from({length:R*C}, ()=>({mine:false,revealed:false,flag:false,adj:0}));
    flags=0; revealed=0; totalNonMine=R*C - M;
    firstClick=true; alive=true;
    resetTimer();
    setStatus('å°±ç»ª');
    setCounters();
  }
  function placeMines(excludeIndex){
    // é¦–å‡»ä¸æ­»ï¼šæ’é™¤é¦–å‡»åŠå…¶é‚»è¿‘ 8 æ ¼
    const forbid = new Set([excludeIndex, ...neigh(excludeIndex)]);
    const pool=[];
    for(let i=0;i<R*C;i++) if(!forbid.has(i)) pool.push(i);
    // éšæœºæ”¾ç½®
    for(let m=0;m<M;m++){
      if(pool.length===0) break; // æç«¯å°ç›˜é˜²å¾¡
      const k = Math.floor(Math.random()*pool.length);
      const pos = pool.splice(k,1)[0];
      cells[pos].mine=true;
    }
    // è®¡ç®—é‚»é›·æ•°
    for(let i=0;i<R*C;i++){
      if(cells[i].mine){ cells[i].adj=-1; continue; }
      let n=0; for(const j of neigh(i)) if(cells[j].mine) n++;
      cells[i].adj=n;
    }
  }

  // â€”â€” äº¤äº’ â€”â€”
  function onLeftClick(e){
    const i = +e.currentTarget.dataset.i;
    if(!alive) return;
    if(cells[i].flag) return;
    if(firstClick){
      placeMines(i);
      firstClick=false;
      startTimer();
      setStatus('è¿›è¡Œä¸­','run');
    }
    reveal(i);
  }
  function onRightClick(e){
    e.preventDefault();
    const i = +e.currentTarget.dataset.i;
    if(!alive) return;
    if(cells[i].revealed) return;
    toggleFlag(i);
  }
  function onChord(e){
    const i=+e.currentTarget.dataset.i;
    if(!alive) return;
    const cell=cells[i];
    if(!cell.revealed || cell.adj<=0) return;
    const ns = neigh(i);
    const flagCount = ns.reduce((a,j)=>a+(cells[j].flag?1:0),0);
    if(flagCount!==cell.adj) return;
    for(const j of ns){
      if(!cells[j].flag && !cells[j].revealed){
        reveal(j);
        if(!alive) break;
      }
    }
  }

  function toggleFlag(i){
    const cell=cells[i];
    if(cell.revealed) return;
    cell.flag=!cell.flag;
    flags += cell.flag?1:-1;
    renderCell(i);
    setCounters();
  }

  function reveal(i){
    const cell=cells[i];
    if(cell.revealed || cell.flag) return;
    cell.revealed=true; revealed++;
    renderCell(i);

    if(cell.mine){
      // è§¦é›·
      alive=false;
      stopTimer();
      exposeAllMines(i);
      setStatus('å¤±è´¥','bad');
      loses++; localStorage.setItem('ms_loses', String(loses));
      updateStats();
      return;
    }
    // ç©ºç™½æ‰©å±•
    if(cell.adj===0){
      for(const j of neigh(i)){
        if(!cells[j].revealed && !cells[j].flag) reveal(j);
      }
    }
    // èƒœåˆ©åˆ¤å®š
    if(revealed===totalNonMine){
      alive=false;
      stopTimer();
      setStatus('èƒœåˆ©','ok');
      wins++; localStorage.setItem('ms_wins', String(wins));
      recordWin();
      updateStats();
      // è‡ªåŠ¨æ’å®Œå‰©ä½™æ——
      for(let k=0;k<cells.length;k++){
        if(cells[k].mine && !cells[k].flag){
          cells[k].flag=true; flags++;
          renderCell(k);
        }
      }
      setCounters();
    }
  }

  function exposeAllMines(triggerIndex){
    for(let i=0;i<cells.length;i++){
      if(cells[i].mine){
        cells[i].revealed=true;
        renderCell(i);
      }
    }
    // æ ‡æ³¨å¼•çˆ†æ ¼
    const d = el.grid.children[triggerIndex];
    if(d) d.style.outline='2px solid var(--bad)';
  }

  function renderCell(i){
    const d = el.grid.children[i];
    const cell = cells[i];
    d.className = 'cell' + (cell.revealed?' revealed':'') + (cell.flag?' flag':'') + (cell.mine?' mine':'');
    if(cell.revealed){
      if(cell.mine){ d.textContent = 'ğŸ’£'; d.setAttribute('aria-label','åœ°é›·'); return; }
      d.textContent = cell.adj>0 ? String(cell.adj) : '';
      if(cell.adj>0) d.classList.add('n'+cell.adj);
      d.setAttribute('aria-label', cell.adj>0?`æ•°å­—${cell.adj}`:'ç©ºç™½');
    }else{
      d.textContent = cell.flag ? 'ğŸš©' : '';
      d.setAttribute('aria-label', cell.flag?'æ——å¸œ':'æœªç¿»å¼€');
    }
  }

  // â€”â€” æˆç»©è®°å½•ä¸æ¦œå• â€”â€”
  function recordWin(){
    const name = getUser() || 'åŒ¿å';
    const rec = {
      name, rows:R, cols:C, mines:M, seconds:t, date:new Date().toISOString()
    };
    const arr = loadScores();
    arr.push(rec);
    // åªä¿ç•™æœ€è¿‘çš„ 500 æ¡
    if(arr.length>500) arr.splice(0, arr.length-500);
    saveScores(arr);
    renderScores();
  }
  function renderScores(){
    const arr = loadScores().slice();
    const onlyMine = el.onlyMine.checked;
    const name = getUser();
    const filtered = arr.filter(r => !onlyMine || r.name===name)
                        .sort((a,b)=>a.seconds-b.seconds)
    const tbody = el.scoreTable;
    tbody.innerHTML='';
    filtered.forEach((r,idx)=>{
      const tr=document.createElement('tr');
      const size=`${r.cols}Ã—${r.rows}`;
      const dt = new Date(r.date);
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${escapeHtml(r.name)}</td>
        <td>${size}</td>
        <td>${r.mines}</td>
        <td>${formatTime(r.seconds)}</td>
        <td>${dt.toLocaleString()}</td>`;
      tbody.appendChild(tr);
    });
  }
  function updateStats(){
    const total = wins+loses;
    const rate = total? Math.round(wins*100/total):0;
    el.stats.textContent = `èƒœï¼š${wins}ï½œè´Ÿï¼š${loses}ï½œèƒœç‡ï¼š${rate}%`;
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

  // â€”â€” UI æ§ä»¶ â€”â€”
  function applyDifficulty(){
    const d = el.difficulty.value;
    if(d==='beginner'){ R=9; C=9; M=10 }
    else if(d==='intermediate'){ R=16; C=16; M=40 }
    else if(d==='expert'){ R=16; C=30; M=99 }
    else { // custom
      R = clamp(parseInt(el.rows.value||'9',10), 5, 50);
      C = clamp(parseInt(el.cols.value||'9',10), 5, 50);
      const maxM = Math.max(1, R*C-1);
      M = clamp(parseInt(el.mines.value||'10',10), 1, maxM);
      el.mines.max = String(maxM);
      el.rows.value=String(R); el.cols.value=String(C); el.mines.value=String(M);
    }
    document.documentElement.style.setProperty('--cell', C>28||R>28?'22px':'28px');
  }
  function clamp(v,min,max){ return isNaN(v)?min:Math.max(min, Math.min(max, v)) }

  function newGame(){
    applyDifficulty();
    setupGrid();
    initCells();
  }

  // â€”â€” äº‹ä»¶ç»‘å®š â€”â€”
  el.newGame.addEventListener('click', newGame);
  el.difficulty.addEventListener('change', ()=>{
    const isCustom = el.difficulty.value==='custom';
    [el.rows,el.cols,el.mines].forEach(x=>x.disabled=!isCustom);
    newGame();
  });
  [el.rows,el.cols,el.mines].forEach(inp=>inp.addEventListener('change', ()=>{
    el.difficulty.value='custom'; newGame();
  }));
  el.flagMode.addEventListener('click', ()=>{
    const on = el.flagMode.dataset.on==='1';
    if(on){ el.flagMode.dataset.on='0'; el.flagMode.textContent='æ ‡è®°æ¨¡å¼ï¼šå…³'; el.flagMode.classList.remove('ok'); el.flagMode.classList.add('warn'); }
    else { el.flagMode.dataset.on='1'; el.flagMode.textContent='æ ‡è®°æ¨¡å¼ï¼šå¼€'; el.flagMode.classList.remove('warn'); el.flagMode.classList.add('ok'); }
  });
  // è§¦æ‘¸æ”¯æŒï¼šç‚¹å‡»æ ¹æ®æ ‡è®°æ¨¡å¼å†³å®šå¼€æ ¼æˆ–æ’æ——
  el.grid.addEventListener('pointerdown', (ev)=>{
    if(ev.pointerType!=='touch') return;
    const tgt = ev.target.closest('.cell'); if(!tgt) return;
    const i=+tgt.dataset.i;
    const flagModeOn = el.flagMode.dataset.on==='1';
    if(flagModeOn){ toggleFlag(i); }
    else { onLeftClick({currentTarget:tgt}); }
  });

  el.saveName.addEventListener('click', ()=>{
    const name = el.username.value.trim().slice(0,32) || '';
    setUser(name);
    el.currentUser.textContent = name?`å½“å‰ç”¨æˆ·ï¼š${name}`:'å½“å‰ç”¨æˆ·ï¼šæœªè®¾ç½®';
    renderScores();
  });
  el.onlyMine.addEventListener('change', renderScores);

  // â€”â€”â€” ä¿®å¤ç‚¹ï¼šæ¸…ç©ºæŒ‰é’®ç°åœ¨ä¼šåŒæ—¶æ¸…ç©ºã€æ¦œå•è®°å½•ã€‘ä¸ã€èƒœè´Ÿç»Ÿè®¡ã€‘ â€”â€”â€”
  el.clearScores.addEventListener('click', ()=>{
    if(confirm('ç¡®å®šæ¸…ç©ºæœ¬åœ°æ‰€æœ‰æˆç»©ä¸èƒœè´Ÿç»Ÿè®¡ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')){
      // æ¸…ç©ºæˆç»©åˆ—è¡¨
      localStorage.removeItem(LS_SCORES);
      saveScores([]);
      renderScores();
      // æ¸…ç©ºèƒœè´Ÿç»Ÿè®¡
      wins = 0; loses = 0;
      localStorage.setItem('ms_wins','0');
      localStorage.setItem('ms_loses','0');
      updateStats();
      setStatus('å·²æ¸…ç©ºæˆç»©ä¸ç»Ÿè®¡','run');
    }
  });

  // â€”â€” å¯åŠ¨ â€”â€”
  (function boot(){
    // æ¢å¤ç”¨æˆ·å
    const name = getUser(); el.username.value=name; el.currentUser.textContent = name?`å½“å‰ç”¨æˆ·ï¼š${name}`:'å½“å‰ç”¨æˆ·ï¼šæœªè®¾ç½®';
    // è‡ªå®šä¹‰è¾“å…¥æ˜¯å¦å¯ç”¨
    const isCustom = el.difficulty.value==='custom';
    [el.rows,el.cols,el.mines].forEach(x=>x.disabled=!isCustom);
    updateStats();
    renderScores();
    newGame();
  })();

})();
</script>
</body>
</html>
